# ==================================================
# CDAX VIDEO PLATFORM - APPLICATION CONFIGURATION
# ==================================================

# ================= APPLICATION SETTINGS =================
spring.application.name=cdaxVideo
server.port=${SERVER_PORT:8080}
server.servlet.context-path=/
server.compression.enabled=true
server.compression.mime-types=text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
server.compression.min-response-size=1024

# ================= DATABASE CONFIGURATION =================
# Railway MySQL connection using environment variables
spring.datasource.url=${SPRING_DATASOURCE_URL:jdbc:mysql://localhost:3306/cdaxx?sessionVariables=autocommit=0}
spring.datasource.username=${SPRING_DATASOURCE_USERNAME:root}
spring.datasource.password=${SPRING_DATASOURCE_PASSWORD:root}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# HikariCP Connection Pool Settings
spring.datasource.hikari.connection-timeout=30000
spring.datasource.hikari.maximum-pool-size=15
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=1800000
spring.datasource.hikari.auto-commit=false
spring.datasource.hikari.connection-init-sql=SET autocommit=0
spring.datasource.hikari.transaction-isolation=TRANSACTION_READ_COMMITTED
spring.datasource.hikari.leak-detection-threshold=60000
spring.datasource.hikari.pool-name=SpringBootHikariCP
spring.datasource.hikari.connection-test-query=SELECT 1
spring.datasource.hikari.validation-timeout=5000
spring.datasource.hikari.allow-pool-suspension=true

# ================= JPA / HIBERNATE CONFIGURATION =================
spring.jpa.hibernate.ddl-auto=${SPRING_JPA_DDL_AUTO:update}
spring.jpa.show-sql=${SPRING_JPA_SHOW_SQL:true}
spring.jpa.open-in-view=false
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.jdbc.batch_size=25
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
spring.jpa.properties.hibernate.generate_statistics=false
spring.jpa.properties.hibernate.connection.provider_disables_autocommit=true
spring.jpa.properties.hibernate.connection.autocommit=false
spring.jpa.properties.hibernate.connection.handling_mode=DELAYED_ACQUISITION_AND_RELEASE_AFTER_TRANSACTION
spring.jpa.properties.hibernate.transaction.jta.platform=org.hibernate.engine.transaction.jta.platform.internal.NoJtaPlatform
spring.jpa.properties.hibernate.current_session_context_class=thread
spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation=true
spring.jpa.properties.hibernate.query.fail_on_pagination_over_collection_fetch=true

# ================= TRANSACTION MANAGEMENT =================
spring.transaction.default-timeout=30
spring.transaction.rollback-on-commit-failure=true
spring.jpa.properties.jakarta.persistence.transaction-type=RESOURCE_LOCAL

# ================= JACKSON / JSON CONFIGURATION =================
spring.jackson.serialization.fail-on-empty-beans=false
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.deserialization.fail-on-unknown-properties=false
spring.jackson.property-naming-strategy=SNAKE_CASE
spring.jackson.date-format=yyyy-MM-dd HH:mm:ss
spring.jackson.time-zone=UTC
spring.jackson.default-property-inclusion=NON_NULL

# ================= STATIC RESOURCES & FILE UPLOAD =================
spring.web.resources.static-locations=classpath:/static/,classpath:/public/,file:./uploads/
spring.servlet.multipart.max-file-size=100MB
spring.servlet.multipart.max-request-size=100MB
spring.servlet.multipart.enabled=true
spring.servlet.multipart.file-size-threshold=2KB
spring.servlet.multipart.location=${java.io.tmpdir}

# ================= ACTUATOR / HEALTH CHECKS =================
management.endpoints.web.exposure.include=health,info,metrics,prometheus
management.endpoint.health.show-details=always
management.endpoint.health.probes.enabled=true
management.endpoint.health.status.order=DOWN,OUT_OF_SERVICE,UP,UNKNOWN
management.metrics.export.prometheus.enabled=true
management.info.env.enabled=true
management.health.db.enabled=true
management.health.diskspace.enabled=true
management.health.diskspace.path=.
management.health.diskspace.threshold=10MB

# ================= JWT SECURITY CONFIGURATION =================
# JWT Secret from Railway environment variable (DO NOT hardcode here!)
jwt.secret=${JWT_SECRET:dev-local-test-secret-change-this-in-production}
jwt.expiration=86400000
jwt.issuer=cdaxVideo
jwt.header=Authorization
jwt.prefix=Bearer
jwt.remember-me-expiration=2592000000
jwt.refresh.expiration=604800000

# ================= CORS CONFIGURATION =================
# CORS settings from Railway environment variables
cors.allowed-origins=${CORS_ALLOWED_ORIGINS:http://localhost:3000}
cors.allowed-methods=GET,POST,PUT,DELETE,OPTIONS,PATCH,HEAD
cors.allowed-headers=Authorization,Content-Type,Accept,Origin,X-Requested-With,Access-Control-Request-Method,Access-Control-Request-Headers,X-CSRF-Token,Cache-Control,Pragma,Accept-Language,Accept-Encoding
cors.exposed-headers=Authorization,Content-Disposition,Content-Length,X-Total-Count
cors.allow-credentials=true
cors.max-age=3600

# ================= LOGGING CONFIGURATION =================
# Log levels - adjust based on environment
logging.level.root=${LOGGING_LEVEL_ROOT:WARN}
logging.level.com.example.cdaxvideo=${LOGGING_LEVEL_APP:INFO}
logging.level.org.springframework.web=${LOGGING_LEVEL_WEB:DEBUG}
logging.level.org.hibernate.SQL=${LOGGING_LEVEL_HIBERNATE_SQL:WARN}
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=${LOGGING_LEVEL_HIBERNATE_BINDER:TRACE}
logging.level.org.springframework.transaction=${LOGGING_LEVEL_TRANSACTION:DEBUG}

# Log file configuration
logging.file.name=logs/application.log
logging.file.max-size=10MB
logging.file.max-history=30
logging.file.total-size-cap=100MB
logging.file.clean-history-on-start=false

# Log patterns
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n
logging.pattern.file=%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n
logging.pattern.level=%5p

# ================= EMAIL CONFIGURATION (if needed) =================
spring.mail.host=${SMTP_HOST:smtp.gmail.com}
spring.mail.port=${SMTP_PORT:587}
spring.mail.username=${SMTP_USERNAME:}
spring.mail.password=${SMTP_PASSWORD:}
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.starttls.required=true
spring.mail.properties.mail.smtp.connectiontimeout=5000
spring.mail.properties.mail.smtp.timeout=5000
spring.mail.properties.mail.smtp.writetimeout=5000

# ================= CACHE CONFIGURATION =================
spring.cache.type=simple
spring.cache.cache-names=courses,users,modules,videos,assessments
spring.cache.simple.size-limit=1000
spring.cache.simple.time-to-live=600000
spring.cache.simple.time-to-idle=300000

# ================= SCHEDULING / ASYNC =================
spring.task.scheduling.pool.size=10
spring.task.scheduling.thread-name-prefix=scheduling-
spring.task.execution.pool.core-size=10
spring.task.execution.pool.max-size=20
spring.task.execution.pool.queue-capacity=500
spring.task.execution.thread-name-prefix=async-
spring.task.execution.shutdown.await-termination=true
spring.task.execution.shutdown.await-termination-period=30s

# ================= SECURITY DEBUG (Railway Production = false) =================
security.debug=false
spring.security.filter.dispatcher-types=ASYNC,ERROR,REQUEST

# ================= FILE STORAGE =================
file.upload-dir=./uploads
file.max-size=104857600
file.allowed-extensions=jpg,jpeg,png,gif,pdf,mp4,webm,avi,mov
file.public-access-path=/uploads/**

# ================= VIDEO PROCESSING =================
video.processing.max-size=1073741824
video.processing.allowed-formats=mp4,webm,avi,mov,mkv
video.processing.thumbnail.width=320
video.processing.thumbnail.height=180

# ================= RATE LIMITING =================
rate.limit.requests-per-second=100
rate.limit.burst-capacity=150

# ================= ENVIRONMENT SPECIFIC =================
# Profile activation (set SPRING_PROFILES_ACTIVE=prod on Railway)
spring.profiles.active=${SPRING_PROFILES_ACTIVE:dev}

# ================= DATABASE VALIDATION =================
spring.datasource.test-on-borrow=true
spring.datasource.validation-query=SELECT 1
spring.datasource.validation-query-timeout=5
spring.datasource.validation-interval=30000

# ================= HTTP CLIENT (REST TEMPLATE) =================
spring.web.client.max-connections-per-route=20
spring.web.client.max-connections-total=100
spring.web.client.connect-timeout=10000
spring.web.client.read-timeout=30000

# ================= SESSION MANAGEMENT =================
server.servlet.session.timeout=1800
server.servlet.session.cookie.http-only=true
server.servlet.session.cookie.secure=${COOKIE_SECURE:false}
server.servlet.session.cookie.same-site=lax

# ================= ERROR HANDLING =================
server.error.include-message=always
server.error.include-binding-errors=on_param
server.error.include-stacktrace=on_param
server.error.path=/error
server.error.whitelabel.enabled=true

# ================= METRICS & MONITORING =================
management.metrics.enable.all=true
management.metrics.distribution.percentiles-histogram.http.server.requests=true
management.metrics.distribution.percentiles-histogram.jvm.memory.used=true
management.metrics.distribution.sla=http.server.requests=100ms,300ms,1s
management.metrics.tags.application=${spring.application.name}
management.metrics.tags.environment=${spring.profiles.active}

# Force Spring MVC to use Ant matcher (more forgiving)
spring.mvc.pathmatch.matching-strategy=ant-path-matcher

# Optional: Enable debug logging to see pattern parsing
logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.web.util.pattern=DEBUG